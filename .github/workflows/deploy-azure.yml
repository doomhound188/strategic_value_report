name: Deploy to Azure Container Apps

on:
  workflow_run:
    workflows: ["Build and Scan Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  AZURE_CONTAINER_APP_NAME: strategic-value-report
  AZURE_RESOURCE_GROUP: strategic-value-report-rg
  CONTAINER_IMAGE: ghcr.io/${{ github.repository }}:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        run: |
          az containerapp update \
            --name ${{ env.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.CONTAINER_IMAGE }}

      - name: Get Container App URL
        id: get-url
        run: |
          URL=$(az containerapp show \
            --name ${{ env.AZURE_CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn \
            --output tsv)
          echo "url=https://$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: https://$URL"

      - name: Deployment Summary
        run: |
          echo "### Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.CONTAINER_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
